# EdgeX Foundry 最新稳定版（单传感器配置）
version: '3.8'
services:
  # 核心配置引导服务
  core-common-config-bootstrapper:
    container_name: edgex-core-common-config-bootstrapper
    image: nexus3.edgexfoundry.org:10004/core-common-config-bootstrapper:latest
    environment:
      EDGEX_SECURITY_SECRET_STORE: "false"
    networks:
      - edgex-network
    restart: always
    user: 2002:2001
    volumes:
      - type: bind
        source: /etc/localtime
        target: /etc/localtime
        read_only: true
  # 核心元数据服务（设备/配置管理）
  core-metadata:
    container_name: edgex-core-metadata
    depends_on:
      core-common-config-bootstrapper:
        condition: service_completed_successfully
    environment:
      EDGEX_SECURITY_SECRET_STORE: "false"
      SERVICE_HOST: edgex-core-metadata
    hostname: edgex-core-metadata
    image: nexus3.edgexfoundry.org:10004/core-metadata:latest
    networks:
      - edgex-network
    ports:
      - mode: ingress
        host_ip: 127.0.0.1
        target: 59881
        published: "59881"
        protocol: tcp
    read_only: true
    restart: always
    security_opt:
      - no-new-privileges:true
    user: 2002:2001
    volumes:
      - type: bind
        source: /etc/localtime
        target: /etc/localtime
        read_only: true

  # 核心数据服务（接收传感器数据）
  core-data:
    container_name: edgex-core-data
    depends_on:
      core-common-config-bootstrapper:
        condition: service_completed_successfully
    environment:
      EDGEX_SECURITY_SECRET_STORE: "false"
      SERVICE_HOST: edgex-core-data
    hostname: edgex-core-data
    image: nexus3.edgexfoundry.org:10004/core-data:latest
    networks:
      - edgex-network
    ports:
      - mode: ingress
        host_ip: 127.0.0.1
        target: 59880
        published: "59880"
        protocol: tcp
      - mode: ingress
        host_ip: 127.0.0.1
        target: 5563
        published: "5563"
        protocol: tcp
    read_only: true
    restart: always
    security_opt:
      - no-new-privileges:true
    user: 2002:2001
    volumes:
      - type: bind
        source: /etc/localtime
        target: /etc/localtime
        read_only: true

  # 核心命令服务（调用传感器命令）
  core-command:
    container_name: edgex-core-command
    depends_on:
      core-common-config-bootstrapper:
        condition: service_completed_successfully
    environment:
      EDGEX_SECURITY_SECRET_STORE: "false"
      SERVICE_HOST: edgex-core-command
    hostname: edgex-core-command
    image: nexus3.edgexfoundry.org:10004/core-command:latest
    networks:
      - edgex-network
    ports:
      - mode: ingress
        host_ip: 127.0.0.1
        target: 59882
        published: "59882"
        protocol: tcp
    read_only: true
    restart: always
    security_opt:
      - no-new-privileges:true
    user: 2002:2001
    volumes:
      - type: bind
        source: /etc/localtime
        target: /etc/localtime
        read_only: true

  # 虚拟设备服务（模拟单风荷载传感器）
  device-virtual:
    container_name: edgex-device-virtual
    command:
      - -cp=keeper.http://edgex-core-keeper:59890
      - --registry
    depends_on:
      core-common-config-bootstrapper:
        condition: service_completed_successfully
      core-data:
        condition: service_started
      core-metadata:
        condition: service_started
    environment:
      EDGEX_SECURITY_SECRET_STORE: "false"
      SERVICE_HOST: edgex-device-virtual
      # 仅定义1个风荷载传感器，10ms间隔=100Hz刷新
      DEVICE_VIRTUAL_DEVICES: >
        [
          {"name":"WindLoadSensor","profileName":"WindLoad","autoEvents":[{"interval":"10ms","onChange":false}]}
        ]
    hostname: edgex-device-virtual
    image: nexus3.edgexfoundry.org:10004/device-virtual:latest
    networks:
      - edgex-network
    ports:
      - mode: ingress
        host_ip: 127.0.0.1
        target: 59900
        published: "59900"
        protocol: tcp
    read_only: true
    restart: always
    security_opt:
      - no-new-privileges:true
    user: 2002:2001
    volumes:
      # 挂载自定义单传感器配置文件
      - type: bind
        source: ../../edgex-config/profiles
        target: /res/profiles
        read_only: true
      - type: bind
        source: /etc/localtime
        target: /etc/localtime
        read_only: true

  # InfluxDB（实时数据存储）
  influxdb:
    container_name: edgex-influxdb
    image: influxdb:2.7-alpine
    environment:
      DOCKER_INFLUXDB_INIT_MODE: setup
      DOCKER_INFLUXDB_INIT_USERNAME: edgex
      DOCKER_INFLUXDB_INIT_PASSWORD: edgex123456
      DOCKER_INFLUXDB_INIT_ORG: pv-monitor
      DOCKER_INFLUXDB_INIT_BUCKET: windload-data
      DOCKER_INFLUXDB_INIT_ADMIN_TOKEN: pv-monitor-token-123
    networks:
      - edgex-network
    ports:
      - mode: ingress
        host_ip: 127.0.0.1
        target: 8086
        published: "8086"
        protocol: tcp
    restart: always
    volumes:
      - type: volume
        source: influxdb-data
        target: /var/lib/influxdb2

  # 可选：EdgeX UI（可视化管理）
  edgex-ui:
    container_name: edgex-ui
    image: nexus3.edgexfoundry.org:10004/edgex-ui:latest
    depends_on:
      core-metadata:
        condition: service_started
      core-command:
        condition: service_started
    networks:
      - edgex-network
    ports:
      - mode: ingress
        host_ip: 127.0.0.1
        target: 4000
        published: "4000"
        protocol: tcp
    restart: always

networks:
  edgex-network:
    driver: bridge
    name: edgex-network

volumes:
  influxdb-data:
    name: edgex-influxdb-data